@using Entity.MiniApp.Conf
@model PageShare
@{
    //行业版同城配置
    ViewBag.Title = "分享配置";
    ViewBag.PageType = 4;//1是行业版同城，用于母版页的左侧菜单区分
    Layout = "~/Views/Shared/_MiniappLayout.cshtml";
  

}
<script src="@(WebSiteConfig.cdnurl)content/active/date/js/mobiscroll_002.js" type="text/javascript"></script>
<script src="@(WebSiteConfig.cdnurl)content/active/date/js/mobiscroll_004.js" type="text/javascript"></script>
<link href="@(WebSiteConfig.cdnurl)content/active/date/css/mobiscroll_002.css" rel="stylesheet" type="text/css">
<link href="@(WebSiteConfig.cdnurl)content/active/date/css/mobiscroll.css" rel="stylesheet" type="text/css">
<script src="@(WebSiteConfig.cdnurl)content/active/date/js/mobiscroll.js" type="text/javascript"></script>
<script src="@(WebSiteConfig.cdnurl)content/active/date/js/mobiscroll_003.js" type="text/javascript"></script>
<script src="@(WebSiteConfig.cdnurl)content/active/date/js/mobiscroll_005.js" type="text/javascript"></script>
<link href="@(WebSiteConfig.cdnurl)content/active/date/css/mobiscroll_003.css" rel="stylesheet" type="text/css">
<link href="@(WebSiteConfig.cdnurl)content/Miniapp/css/iconfont.css" rel="stylesheet" />

<link href="@(WebSiteConfig.cdnurl)content/Miniapp/css/jquery.dad.css" rel="stylesheet" />
<style>
    .flex-v { -webkit-box-orient: vertical; -webkit-box-direction: vertical; -ms-flex-direction: column; flex-direction: column; -webkit-flex-direction: column; }
    .d-flex { display: -webkit-box; display: -webkit-flex; display: -ms-flexbox; display: flex; }
    /*.flex { -webkit-box-flex: 1; -webkit-flex: 1; -ms-flex: 1; flex: 1; }*/
    .d-flex-center { align-items: center; -webkit-box-align: center; -webkit-align-items: center; -ms-flex-align: center; }


    .headTxt{color:red}
    .form-control{ display:inline-block;}
    .rightPreviewImg{width:100%;}
    .leftMsg{margin:auto;}
    .logo{height:10%;}
    .headTitle {height: 30%; }
    .AdImg { height: 25%; }
    .tipTxt { height: 10%; }
    .qrCode { height: 25%; }
    .prvDiv div{margin-bottom:20px;}

</style>
<input type="hidden" id="CName_Hidden" value="小程序" />
<div class="row">
 
        <div class="leftMsg">
            <table class="table table-condensed table-hover cancel-table-td-border ">
                <tr>
                    <td style="text-align: right;" width="20%"> </td>
                    <td>
                        <div class="headTxt">
                            开启分享按钮后,用户可以在指定页面上点击一键分享按钮生成带小程序的二维码
                        </div>
                    </td>
                </tr>
                <tr>
                    <td style="text-align: right;" width="20%">分享按钮:</td>
                    <td>
                        <input class="IsOpen" name="IsOpen" type="radio"  value="1" @(Model.IsOpen>0?"checked":string.Empty)> 开启
                        <input class="IsOpen" name="IsOpen" type="radio" value="0" @(Model.IsOpen==0?"checked":string.Empty)> 关闭

                    </td>
                </tr>
                <tr>
                    <td style="text-align: right;" width="20%">分享引导语:</td>
                    <td><input type="text" class="form-control width400" id="ShareTitle" value="@Model.ShareTitle" /><label style="color: red">*写一句简单介绍</label></td>
                </tr>
                <tr>
                    <td style="text-align: right;" width="20%">店铺名称:</td>
                    <td><input type="text" class="form-control width400" id="Title" value="@Model.Title"/><label style="color: red">*建议10个字以内</label></td>
                </tr>
               
                <tr>
                    <td style="text-align: right;" width="20%">摘要:</td>
                    <td><input type="text" class="form-control width400" value="@Model.Remark" id="Remark" /><label style="color: red">*建议20个字以内</label></td>
                </tr>
                <tr>
                    <td style="text-align: right;" width="20%">店铺Logo:</td>
                    <td>
                        <div class="i_Posters">
                            <div style="position:relative;display:inline-block;" data-img="@Model.Logo" style="width:130px;height:130px;">
                                <img src="@(string.IsNullOrEmpty(Model.Logo)?"@(WebSiteConfig.cdnurl)content/Miniapp/imgs/imageUpload.png":Model.Logo)" class="defaultUploadAttr LogoImgItem" title="点击上传" style="display:block" />
                                @*<span class="DelPoster" style="position: absolute;right:0px;top: 0px;display:@(string.IsNullOrEmpty(Model.Logo)?"none":"block")"><i style="font-size: x-large;cursor: pointer;" class="Hui-iconfont"></i></span>*@
                            </div>
                        </div>
                        <label style="color: red">*建议上传130*130px 一张小于1M格式jpg或者png</label>
                    </td>
                </tr>
                <tr>
                    <td style="text-align: right;" width="20%">广告图:</td>
                    <td>
                        <div class="i_Posters">

                            <div style="position:relative;" data-img="@Model.ADImg" style="width:480px;height:270px;">
                                <img src="@(string.IsNullOrEmpty(Model.ADImg)?"@(WebSiteConfig.cdnurl)content/Miniapp/imgs/imageUpload.png":Model.ADImg)" class="defaultUploadAttr AdImgItem" title="点击上传" style="display:block" />
                                @*<span class="DelPoster" style="position: absolute;right:0px;top: 0px;display:@(string.IsNullOrEmpty(Model.Logo)?"none":"block")"><i style="font-size: x-large;cursor: pointer;" class="Hui-iconfont"></i></span>*@

                            </div>
                        </div>
                        <label style="color: red">*建议上传480*270px 一张小于1M格式jpg或者png</label>
                    </td>
                </tr>
            </table>
        </div>
    <div style="position:absolute;width:30%;margin-top: -27%;margin-left: 50%;">
        <div class="rightPreviewImg d-flex flex-v" style="height:100%;background-image:url(/Content/Miniapp/imgs/share/sharebg.png)" id="rightPreviewImg">
            <div style="padding:70px;">
                <div style="border:0.3rem solid #ccc;padding:20px;" class="prvDiv">
                    <div class="logo" style="margin-bottom:0px;">
                        <img src="@ViewBag.Logo" style="margin-left:37%;margin-top:-20%;height:130px;width:130px;" />
                    </div>
                    <div class="headTitle" style="text-align:center;">
                        <h1>@(string.IsNullOrEmpty(Model.Title) ? "店铺名称" : Model.Title)</h1>
                        <p>@(string.IsNullOrEmpty(Model.Remark) ? "店铺摘要描述" : Model.Remark)</p>
                    </div>
                    <div class="AdImg">
                        <img src="@ViewBag.ADImg" style="width:100%;" />
                    </div>
                    <div class="tipTxt" style="text-align:center">
                        <p>@(string.IsNullOrEmpty(Model.ShareTitle) ? "长按或扫描一下二维码参观店铺" : Model.ShareTitle)</p>
                    </div>
                    <div class="qrCode" style="text-align:center;" data-img="@Model.QrCodeImg">
                        <img src="@ViewBag.QrCodeImg" style="width:200px;height:200px;" />
                    </div>
                </div>
            </div>
        </div>
    </div>
       
     

</div>

<div class="col-md-offset-2">
    <input type="button" class="btn btn-primary width100" id="saveBtn" value="保存" />
    <input type="button" class="btn btn-primary width100" id="saveBtnQRCode" value="获取小程序码" style="background-color:#03A9F4!important" data-id="@Model.Id" />
</div>





<input id="ImgUrlAttr" type="file" name="ImgUrlImgUrlAttr" onchange="UploadImgAttr()" style="height: 0px; width: 0px;opacity:0;" />
<link href="@(WebSiteConfig.cdnurl)js/umditor_common/themes/default/css/umeditor.min.css" rel="stylesheet" />
<script src="@(WebSiteConfig.cdnurl)js/umditor_common/umeditor.min.js"></script>
<script src="@(WebSiteConfig.cdnurl)js/umditor_common/umeditor.config.js"></script>

<script src="@(WebSiteConfig.cdnurl)content/assets/global/plugins/bootstrap-maxlength/bootstrap-maxlength.min.js"></script>
@*<script src="@(WebSiteConfig.cdnurl)content/Home/js/jquery.min.js"></script>*@
<script src="@(WebSiteConfig.cdnurl)content/Miniapp/js/jquery.dad.min.js"></script>
<script src="@(WebSiteConfig.cdnurl)content/Miniapp/js/ajaxfileupload.js"></script>
<script src="//j.vzan.cc/zhibo/livecontent/plugin/html2canvas.min.js"></script>
@section script{
  
    <script>
        var thisUploadImg;//全局变量 保存属性当前点击的的上传图片
        $(function () {

            $("#saveBtn").click(function(){

                var IsOpen= $("input[name='IsOpen']:checked").val();

                var ShareTitle = $("#ShareTitle").val();
                if (ShareTitle == '') {
                    AppTools.Alert("分享引导语不能为空!");
                    return;
                }

                var Title = $("#Title").val();
                if (Title == '') {
                    AppTools.Alert("店铺名称不能为空!");
                    return;
                }

                var Remark = $("#Remark").val();
                if (Remark == '') {
                    AppTools.Alert("摘要不能为空!");
                    return;
                }

                var Logo = $(".LogoImgItem").parent().data("img");
                if(Logo=='')
                {
                    AppTools.Alert("店铺Logo不能为空!");
                    return;
                }

                var ADImg = $(".AdImgItem").parent().data("img");
                if (ADImg == '') {
                    AppTools.Alert("店铺广告图不能为空!");
                    return;
                }

                var qrCode=$(".qrCode").data("img");
                if(qrCode==''){
                    AppTools.Alert("请先获取小程序码!");
                    return;
                }

                var shareId=$("#saveBtnQRCode").data("id");

                html2canvas($(".rightPreviewImg")).then(function (canvas) {
                   var imgUri = canvas.toDataURL("image/jpg").replace("image/jpg", "image/octet-stream"); // 获取生成的图片的url  ;
                  //  window.location.href = imgUri;


                    $.ajax({
                        type: 'POST',
                        url: '/pageindex/SetPageShare',
                        data: {Id:shareId,relationId:@ViewBag.Id,base64Str:imgUri,ShareTitle:ShareTitle,Title:Title,Logo:Logo,Remark:Remark,ADImg:ADImg,IsOpen:IsOpen,QrCodeImg:qrCode },
                        dataType: 'json',
                        success: function (data) {
                            if (data.isok) {
                                AppTools.Alert(data.msg);
                            }
                            else {
                                AppTools.Alert(data.msg);
                            }
                        },
                        error: function (rdata) {
                            AppTools.Alert("参数错误");
                        }
                    });

                });




            });




            $(document).on("click", ".defaultUploadAttr", function () {
                thisUploadImg = $(this);
                $("#ImgUrlAttr").click();
            }).on("click", "#saveBtnQRCode", function () {
                $.ajax({
                    type: 'POST',
                    url: '/pageindex/GetQrCode',
                    data: { shareId:@Model.Id,relationId:@ViewBag.Id },
                    dataType: 'json',
                    success: function (data) {

                        if (data.isOk) {
                            $("#saveBtnQRCode").data("id",data.shareId);
                            $(".qrCode").find("img").attr("src",data.Base64Str);
                            $(".qrCode").data("img",data.imgPath);
                            AppTools.Alert(data.Msg);
                        }
                        else {
                            AppTools.Alert(data.Msg);
                        }
                    },
                    error: function (rdata) {
                        AppTools.Alert("参数错误");
                    }
                });


            }).on("click", ".DelPoster", function () {

                $(this).prev().attr("src", "@(WebSiteConfig.cdnurl)content/Miniapp/imgs/imageUpload.png");
                $(this).css("display", "none");
                $(this).parent().data("img",'');

            }).on("keyup", "#ShareTitle", function () {
                $(".tipTxt").find("p").html($(this).val());
            }).on("keyup", "#Title", function () {
                $(".headTitle").find("h1").html($(this).val());
            }).on("keyup", "#Remark", function () {
                $(".headTitle").find("p").html($(this).val());
            });


        });

        //上传图片
        function UploadImgAttr() {

            $.ajaxFileUpload({
                type: 'POST',
                url: '/pageindex/UploadImgShare',
                secureuri: false,
                fileElementId: 'ImgUrlAttr',
                dataType: 'json',
                success: function (data) {

                    if (data.Success) {
                        thisUploadImg.attr("src", data.Path);
                        $(thisUploadImg).parent().data("img",data.Path);
                        thisUploadImg.next().css("display", "block");
                        if ($(thisUploadImg).hasClass("LogoImgItem")) {
                            $(".logo").find("img").attr("src", data.Base64Str);
                        }
                        if ($(thisUploadImg).hasClass("AdImgItem")) {
                            $(".AdImg").find("img").attr("src", data.Base64Str);
                        }


                    }
                    else {
                        AppTools.Alert(data.Msg);
                    }
                },
                error: function (rdata) {
                    AppTools.Alert("参数错误");
                }
            });
        }

    </script>
}
